name: Build and release firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        file:
          - coaxial.json

    steps:
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            qmk_firmware
          key: ${{ runner.os }}-deps-${{ hashFiles('**/requirements.txt', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 python3-pip gcc-avr avr-libc binutils-avr jq
          python3 -m pip install --upgrade pip qmk keymap-drawer

      - name: Setup QMK
        run: |
          if [ ! -d "qmk_firmware" ]; then qmk setup -y; fi

      - name: Checkout userspace
        uses: actions/checkout@v3
        with:
          path: qmk_firmware/users/${{ github.actor }}

      - name: Generate keymap SVG
        run: |
          cd qmk_firmware/users/${{ github.actor }}
          keymap parse -q coaxial.json | keymap draw - > coaxial.svg
          cd -
          mv qmk_firmware/users/${{ github.actor }}/coaxial.svg .

      - name: Build firmware
        run: |
          cd qmk_firmware/
          qmk compile "users/${{ github.actor }}/${{ matrix.file }}"

      - name: Upload firmware and SVG
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.actor }}
          path: |
            *.hex
            *.bin
            *.uf2
            coaxial.svg
          retention-days: 5

  commit_svg:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.actor }}

      - name: Commit and push updated SVG
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add coaxial.svg
          git commit -m 'docs: update keymap SVG [skip ci]' || echo "No changes to commit"
          git push

  pr_comment:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip keymap-drawer lxml

      - name: Checkout base branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Checkout head branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: head

      - name: Generate diff SVG
        run: |
          cd head
          python3 scripts/generate_diff_svg.py ../base/coaxial.json coaxial.json ../diff.svg
          ls -la ../diff.svg  # Verify file exists and has content
          head -20 ../diff.svg  # Check SVG content for highlights

      - name: Upload diff SVG to catbox.moe
        id: upload
        run: |
          if [ -f diff.svg ]; then
            url=$(curl -s -F reqtype=fileupload -F fileToUpload=@diff.svg https://catbox.moe/user/api.php)
            echo "Upload response: $url"  # Log upload result
            if [[ $url == https://* ]]; then
              echo "diff_svg_url=$url" >> $GITHUB_OUTPUT
            else
              echo "Upload failed: $url"
              exit 1
            fi
          else
            echo "diff.svg not found"
            exit 1
          fi

      - name: Create or update PR comment with diff SVG
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Keymap Layout Diff Preview
            ![Keymap Diff SVG](${{ steps.upload.outputs.diff_svg_url }})

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: "lts/*"

      - name: Install dependencies
        run: npm i

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.actor }}

      - name: Semantic Release
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
