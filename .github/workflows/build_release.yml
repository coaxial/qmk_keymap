name: Build and release firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        file:
          - coaxial.json

    steps:
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            qmk_firmware
          key: ${{ runner.os }}-deps-${{ hashFiles('**/requirements.txt', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 python3-pip gcc-avr avr-libc binutils-avr jq
          python3 -m pip install --upgrade pip qmk keymap-drawer

      - name: Get QMK
        uses: actions/checkout@v5
        with:
          repository: qmk/qmk_firmware
          path: qmk_firmware
          ref: master
          fetch-depth: 1
          submodules: recursive

      - name: Setup QMK
        run: |
          qmk setup -y

      - name: Checkout userspace
        uses: actions/checkout@v5
        with:
          path: qmk_firmware/users/${{ github.actor }}

      - name: Generate keymap SVG
        run: |
          cd qmk_firmware/users/${{ github.actor }}
          keymap -c drawer_config.yaml parse -q coaxial.json | keymap -c drawer_config.yaml draw - > coaxial.svg
          cd -
          mv qmk_firmware/users/${{ github.actor }}/coaxial.svg .

      - name: Build firmware
        run: |
          cd qmk_firmware/
          qmk --version
          qmk compile "users/${{ github.actor }}/${{ matrix.file }}"

      - name: Upload firmware and SVG
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.actor }}
          path: |
            *.hex
            *.bin
            *.uf2
            coaxial.svg
          retention-days: 5

  commit_svg:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.actor }}

      - name: Commit and push updated SVG
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add coaxial.svg
          git commit -m 'docs: update keymap SVG [skip ci]' || echo "No changes to commit"
          git push

  pr_comment:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.actor }}

      - name: Upload SVG
        id: upload-svg
        uses: McCzarny/upload-image@v2.0.1
        with:
          path: coaxial.svg
          upload-method: cloudinary
          api-key: ${{ secrets.CLOUDINARY_API_KEY }}
          api-secret: ${{ secrets.CLOUDINARY_API_SECRET }}
          cloud-name: ${{ secrets.CLOUDINARY_CLOUD_NAME }}

      - name: Create or update PR comment with SVG
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## New keymap layout preview

            ![Keymap SVG](${{ steps.upload-svg.outputs.url }})

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: "lts/*"

      - name: Install dependencies
        run: npm i

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.actor }}

      - name: Semantic Release
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
